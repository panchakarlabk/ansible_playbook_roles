---
# tasks/main.yml

- name: Daily Monitor Logs DR PE restore log status
  shell: tail -n 10 "{{ log_path }}"  >> /tmp/all_logs.txt 2>&1
  register: log_output
  ignore_errors: yes  # Optional: In case the log file doesn't exist or there's a permission issue.
  delegate_to: localhost
  
- name: Dr Pe logs 
  ansible.builtin.debug:
     msg: "{{ log_output }}"
  register: log_output
  delegate_to: localhost
# - name: Append logs to a single file on localhost
#   lineinfile:
#     path: "/tmp/all_logs.txt"
#     line: |
#       ### Logs from host: {{ inventory_hostname }} ###
#       {% if log_output.stdout_lines %}
#       {{ log_output.stdout_lines | join('\n') }}
#       {% else %}
#       No logs found.
#       {% endif %}
#     create: yes
#     insertafter: EOF  # Ensures the new content is appended to the end of the file
#   delegate_to: localhost  # Run this task on the control machine

- name: Display the content of all_logs.txt
  command: cat /tmp/all_logs.txt
  delegate_to: localhost  # Run the task on the control machine
  register: all_logs

# - name: Collect logs from all hosts and combine them into a single variable
#   set_fact:
#     all_logs: "{{ all_logs | default('') + '\n\nLogs from host ' + inventory_hostname + ':\n' + (log_output.stdout_lines | join('\n') | default('No logs found')) }}"
#   #run_once: true  # Ensures the task runs only once and collects logs from all hosts

- name: Send mail notification with logs from all hosts
  community.general.mail:
    host: smtp.gmail.com
    port: 587
    username: "{{ email_username }}"
    password: "{{ email_password }}"
    to: panchakarlabk@gmail.com
    subject: "Daily Monitor Logs DR PE restore log status"
    body: "{{ all_logs }}"
  when: all_logs is defined
  run_once: true
