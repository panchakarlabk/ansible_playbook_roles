
---
- name: Display the collected alerts
  ansible.builtin.command: cat data.json 
  delegate_to: localhost
  register: json_content
  run_once: true

- name: Debug parsed data structure
  debug:
    var: json_content.stdout

- name: Parse JSON content
  set_fact:
    parsed_json: "{{ json_content.stdout | from_json }}"

# - name: Filter relevant alerts
#   set_fact:
#     relevant_alerts: "{{ parsed_json.parse_data['items'] | list }}"

- name: Filter alerts based on ignore rules
  set_fact:
    relevant_alerts: >-
      {{
        parsed_json.parse_data['items'] |
        reject(
          lambda item: ignore_alerts_rules |
          selectattr('ignore_if', 'defined') |
          selectattr('ignore_if', 'select', lambda condition: 
            condition.items() | map('equalto', item.items()) | list | any
          ) |
          list |
          length > 0
        ) |
        list
      }}


- name: Append epoch time from groups.date
  set_fact:
    epoch_times: "{{ (item.groups.date | int) if (item.groups is defined and 'date' in item.groups) else None  }}"
  loop: "{{ parsed_json.parse_data['items'] }}"
  when: item.groups is defined

- name: Extract human-readable time from epoch times
  set_fact:
    time_fact: "{{ '%H:%M:%S' | strftime(epoch_times) }}"

- name: Extract human-readable date from epoch times
  set_fact:
    date_fact: "{{ '%Y-%m-%d' | strftime(epoch_times) }}"



# - name: Display relevant alerts
#   debug:
#     msg: >
#       Ask Comment: {{ item.askComment }}
#       Monitor Object Name: {{ item.monitorObjectName }}
#       Resource Template Name: {{ item.resourceTemplateName }}
#   with_items: "{{ relevant_alerts }}"

# - name: Convert epoch times to human-readable format
#   set_fact:
#     updated_items: >-
#       {{ parse_data.items | map('combine', {
#         'groups': {
#           'date': (item.groups.date | default(0) | string | to_datetime('%Y-%m-%d %H:%M:%S'))
#         }
#       }) | list }}

# - name: Debug updated items
#   debug:
#     var: updated_items

# - name: Prepare filtered alerts for logging with current date
#   set_fact:
#     logic_monitor_email_body: |
#       | Date                 | Ask Comment  | Monitor Object Name   | Resource Template Name  |
#       |----------------------|--------------|-----------------------|-------------------------|
#       {% for item in relevant_alerts %}
#       | {{ ansible_date_time.iso8601 }} | {{ item.askComment | default('') }}{{ ' ' * (12 - item.askComment | length) }} | {{ item.monitorObjectName | default('') }}{{ ' ' * (21 - item.monitorObjectName | length) }} | {{ item.resourceTemplateName | default('') }}{{ ' ' * (23 - item.resourceTemplateName | length) }} |
#       {% endfor %}
#  when: relevant_alerts | length > 0

# - name: Prepare filtered alerts for email in HTML table format
#   set_fact:
#     logic_monitor_email_body: |
#       <html>
#         <head>
#           <style>
#             table {
#               width: 100%;
#               border-collapse: collapse;
#               font-family: Arial, sans-serif;
#               font-size: 14px;
#             }
#             th, td {
#               border: 1px solid #dddddd;
#               text-align: left;
#               padding: 8px;
#             }
#             th {
#               background-color: #f2f2f2;
#             }
#             tr:nth-child(even) {
#               background-color: #f9f9f9;
#             }
#           </style>
#         </head>
#         <body>
#           <p>Here are the filtered alerts:</p>
#           <table>
#             <thead>
#               <tr>
#                 <th>Date</th>
#                 <th>Ask Comment</th>
#                 <th>Monitor Object Name</th>
#                 <th>Resource Template Name</th>
#               </tr>
#             </thead>
#             <tbody>
#               {% for item in relevant_alerts %}
#               <tr>
#                 <td>{{ ansible_date_time.iso8601 }}</td>
#                 <td>{{ item.askComment | default('') }}</td>
#                 <td>{{ item.monitorObjectName | default('') }}</td>
#                 <td>{{ item.resourceTemplateName | default('') }}</td>
#               </tr>
#               {% endfor %}
#             </tbody>
#           </table>
#         </body>
#       </html>
#   when: relevant_alerts | length > 0
